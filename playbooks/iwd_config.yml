---
- name: Configure wireless with iwd
  hosts: all
  become: true
  gather_facts: yes # Ensure facts are gathered

  vars_prompt:
    - name: wifi_ssid
      prompt: "Enter the Wi-Fi SSID"
      private: false
    - name: wifi_passphrase
      prompt: "Enter the Wi-Fi passphrase"
      private: true

  pre_tasks:
    - block:
        - name: Install iwd & iwgtk
          aur:
            use: auto
            name: "{{ item }}"
            state: present
          with_items:
            - iwd
            - iwgtk
          become: false
      rescue:
        - name: Installing packages failed
          ansible.builtin.debug:
            msg: "Failed to install iwd or iwgtk"

    - name: Enable and start iwd service
      service:
        name: iwd
        state: started
        enabled: yes

    - name: Configure WPA/WPA2 network
      copy:
        content: |
          [Security]
          Passphrase={{ wifi_passphrase }}
        dest: "/var/lib/iwd/{{ wifi_ssid | urlencode }}.psk"
      vars:
        wifi_ssid: "{{ wifi_ssid }}"
        wifi_passphrase: "{{ wifi_passphrase }}"
