---
# Intel GPU specific tasks

- name: Intel GPU configuration
  ansible.builtin.debug:
    msg:
      - "Configuring Intel GPU: {{ video.gpu.model }}"
      - "Driver: {{ video.x11.driver | default(gpu_driver_configs.intel.driver) }}"

- name: Enable Intel GPU power management
  ansible.builtin.lineinfile:
    path: /etc/modprobe.d/i915.conf
    line: "options i915 enable_guc=2 enable_fbc=1"
    create: true
    mode: "0644"
  become: true
  when: video.gpu.model in ['iris_xe', 'uhd_graphics']
  tags: ["intel", "power"]

- name: Configure Intel GPU frequency scaling
  ansible.builtin.copy:
    dest: /etc/udev/rules.d/99-intel-gpu.rules
    content: |
      # Intel GPU frequency scaling
      SUBSYSTEM=="drm", KERNEL=="card0", ATTR{device/power_dpm_force_performance_level}="auto"
    mode: "0644"
  become: true
  when: video.gpu.vendor == "intel"
  tags: ["intel", "performance"]

- name: Verify Intel GPU driver loading
  ansible.builtin.command:
    cmd: "lsmod | grep i915"
  register: intel_driver_check
  failed_when: false
  changed_when: false
  tags: ["intel", "validation"]

- name: Display Intel driver status
  ansible.builtin.debug:
    msg:
      - "Intel i915 driver status:"
      - "{{ 'Loaded' if intel_driver_check.rc == 0 else 'Not loaded' }}"
  tags: ["intel", "validation"]
