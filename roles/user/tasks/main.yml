---
# tasks file for user
# 1. Ensure the user exists with the specified shell and groups.
- name: Ensure user is present with proper shell and groups
  user:
    name: "{{ user.name }}"
    shell: "{{ user.shell | default('/bin/zsh') }}"
    groups: "{{ user.groups | default([]) }}"
    append: yes
    state: present

- block:
    - name: Check if keys are present
      stat:
        path: "{{ user.home }}/.ssh/id_ed25519"
      register: keys

    - name: Start ssh daemon
      service:
        name: sshd
        state: started
        enabled: True

    - name: Copy keys from remote host
      delegate_to: 127.0.0.1
      run_once: True
      become_user: "{{ user.name }}"
      shell: "scp {{ user.name }}@{{ keyserver }}:~/.ssh/{{ item }} {{ user.home }}/.ssh/{{ item }}"
      args:
        chdir: "{{ user.home }}"
      with_items:
        - id_ed25519
        - id_ed25519.pub
        - id_rsa
        - id_rsa.pub
        - config
        - known_hosts
        - authorized_keys
      when:
        - not keys.stat.exists
        - keyserver is defined

  tags: ["keys"]

- when: user.sudoers |default(false)
  become: true
  block:
    - name: Ensure /etc/sudoers.d exists
      file:
        path: /etc/sudoers.d/
        state: directory
        owner: root
        mode: '0700'
        group: root
        recurse: true

    - name: Set NOPASSWD for user in sudoers
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/99-user
        line: '{{ user.name }} ALL=(ALL:ALL) NOPASSWD: ALL'
        validate: '/usr/sbin/visudo -cf %s'
        mode: '0440'
        owner: root
        group: root
        create: true
        backup: true
      when: user.name != 'root'

    - name: Set NOPASSWD for user in polkit
      copy:
        content: |
          /* Allow members of the wheel group to execute any actions
          * without password authentication, similar to "sudo NOPASSWD:"
          */
          polkit.addRule(function(action, subject) {
            if (subject.isInGroup("wheel")) {
              return polkit.Result.YES;
            }
          });
        dest: "/etc/polkit-1/rules.d/49-nopasswd_global.rules"
        mode: '0644'
      when: ansible_os_family == 'Archlinux'