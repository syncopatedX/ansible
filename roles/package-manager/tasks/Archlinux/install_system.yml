---
# Install packages using Arch Linux system package managers (pacman/AUR)

- name: Extract package names for system installation
  set_fact:
    system_package_names: >-
      {{
        packages_to_install | map(attribute='name') | list
      }}
  when: packages_to_install | length > 0

- name: Install packages via pacman
  pacman:
    name: "{{ system_package_names }}"
    state: present
    update_cache: false
  become: true
  register: pacman_result
  ignore_errors: true
  when: packages_to_install | length > 0

- name: Install packages via AUR (for failed pacman packages)
  shell: |
    {{ arch_linux.aur_helper | default('paru') }} -S {{ item }} {{ arch_linux.makepkg_flags | default('--noconfirm --needed') }}
  loop: "{{ system_package_names }}"
  become: false
  become_user: "{{ arch_linux.aur_builder }}"
  register: aur_result
  ignore_errors: true
  when: 
    - pacman_result is failed
    - arch_linux.aur_helper is defined
    - packages_to_install | length > 0

# Process results and update tracking variables
- name: Process system installation results
  set_fact:
    package_manager_success: >-
      {{
        package_manager_success + 
        (packages_to_install | selectattr('name', 'in', pacman_result.packages | default([])) | list) +
        (packages_to_install | selectattr('name', 'in', aur_result.results | default([]) | selectattr('stdout', 'search', 'installing') | map(attribute='item') | list) | list)
      }}
    package_manager_failed: >-
      {{
        package_manager_failed +
        (packages_to_install | rejectattr('name', 'in', 
          (pacman_result.packages | default([])) +
          (aur_result.results | default([]) | selectattr('stdout', 'search', 'installing') | map(attribute='item') | list)
        ) | list)
      }}
  when: packages_to_install | length > 0

- name: Display system installation results
  debug:
    msg: |
      Arch Linux system package installation completed:
      - Attempted: {{ packages_to_install | length }}
      - Successful: {{ package_manager_success | length }}
      - Failed: {{ package_manager_failed | length }}
  when: 
    - package_manager.debug | default(false)
    - packages_to_install | length > 0