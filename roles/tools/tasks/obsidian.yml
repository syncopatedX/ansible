---
# ============================================================================
# Obsidian Installation
# Downloads and installs Obsidian AppImage (RedHat family only)
# ============================================================================

- name: Check if Obsidian is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/obsidian
  register: obsidian_check
  ignore_errors: "{{ ansible_check_mode }}"

- name: Install Obsidian AppImage
  when:
    - not obsidian_check.stat.exists
    - ansible_os_family == "RedHat"
  block:
    - name: Download Obsidian AppImage
      ansible.builtin.get_url:
        url: "{{ obsidian.base_url }}/{{ obsidian.appimage }}"
        dest: "/tmp/{{ obsidian.appimage }}"
        mode: "0755"
        validate_certs: false
      register: obsidian_download

    - name: Install Obsidian binary to /usr/local/bin
      ansible.builtin.copy:
        src: "/tmp/{{ obsidian.appimage }}"
        dest: /usr/local/bin/obsidian
        mode: "0755"
        remote_src: true
      become: true

    - name: Install desktop entry for Obsidian
      ansible.builtin.copy:
        src: usr/local/applications/obsidian.desktop
        dest: /usr/local/share/applications/obsidian.desktop
        mode: "0644"
      notify: update desktop database

  rescue:
    - name: Log Obsidian installation failure
      ansible.builtin.debug:
        msg: >
          Failed to install Obsidian.
          Error details: {{ ansible_failed_result | default('Unknown error') }}
          Check network connectivity and AppImage URL validity.