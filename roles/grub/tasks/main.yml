---
# tasks file for grub

- name: Set default kernel parameters
  lineinfile:
    dest: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT'
    state: present
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="{{ kernel_parameters_default }}"'
  when: kernel_parameters_default is defined
  notify:
    - rebuild grub

- name: Set default kernel parameters
  lineinfile:
    dest: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX'
    state: present
    line: 'GRUB_CMDLINE_LINUX="{{ kernel_parameters }}"'
  when: kernel_parameters is defined
  notify:
    - rebuild grub

- name: enable Grub submenus
  lineinfile:
    dest: /etc/default/grub
    regexp: '^GRUB_DISABLE_SUBMENU'
    state: present
    line: '#GRUB_DISABLE_SUBMENU=y'
  notify:
    - rebuild grub

- name: Enable saved as default
  lineinfile:
    dest: /etc/default/grub
    regexp: '^GRUB_DEFAULT'
    state: present
    line: 'GRUB_DEFAULT=saved'
  notify:
    - rebuild grub

- name: Enable saved as default
  lineinfile:
    dest: /etc/default/grub
    regexp: '^#GRUB_SAVEDEFAULT'
    state: present
    line: 'GRUB_SAVEDEFAULT=true'
  notify:
    - rebuild grub

- tags: ["packages", "grub_pkgs"]
  become: false
  block:
    - name: Install grub pacman hook
      aur:
        use: auto
        name: grub-hook
        state: present
      notify:
        - rebuild grub
  rescue:
    - name: Installing base packages failed
      debug:
        msg: "Failed to install base packages"
