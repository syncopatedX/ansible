---
# tasks file for packages

# - name: Set pacman.conf config
#   template:
#     src: etc/pacman.conf.j2
#     dest: /etc/pacman.conf
#     mode: "0644"
#     backup: true
#   tags: ["pacman"]

- import_tasks:
    file: repos.yml
  when: ansible_architecture != "aarch64"
  tags: ["repos"]

- import_tasks:
    file: paru.yml
  when: ansible_architecture != "aarch64"
  tags: ["paru"]

- tags: ["packages", "base_pkgs"]
  block:
    - name: Install base packages
      aur:
        use: auto
        name: "{{ item }}"
        state: present
      with_items: "{{ packages.base }}"
  rescue:
    - name: Installing packages failed
      debug:
        msg: "Failed to install shell packages"

- name: Check if mirrors have been updated within the past 24h
  shell: | 
    fd --changed-within 24hours --search-path=/etc/pacman.d
  register: mirror_status
  tags: ["mirrors"]

- name: Print mirror file status
  debug:
    msg: "{{ mirror_status }}"
  when:
    - ( mirror_status.stdout_lines | length < 0 or update_mirrors is defined )
    - debugging is defined
  tags: ["mirrors"]

- name: update mirrorlist
  shell: |
    reflector --download-timeout 2 --protocol https --latest 20 \
    --sort rate --score 15 --fastest 10 \
    --save /etc/pacman.d/mirrorlist
  when: ( mirror_status.stdout_lines | length < 0 or update_mirrors is defined )
  changed_when: false
  tags: ["mirrors"]

- name: Set makepkg to use aria2
  template:
    src: etc/makepkg.conf.j2
    dest: /etc/makepkg.conf
    mode: "0644"
    backup: true
  tags: ["makepkg"]

- import_tasks:
    file: updatedb.yml
  tags: ["updatedb"]

