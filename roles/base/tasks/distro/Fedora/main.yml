---
- name: Install python3-libdnf5 and fedora-workstation-repositories
  ansible.builtin.dnf:
    name: "{{ item  }}"
    state: present
  with_items:
    - python3-libdnf5
    - fedora-workstation-repositories
  tags: ["packages", "packages__repos"]

# Repository Installation Block
- name: Repository Setup
  block:
    - name: Install RPM Fusion Free repository
      ansible.builtin.dnf:
        name: "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: yes
      tags: ["rpmfusion"]

    - name: Install RPM Fusion Non-Free repository
      ansible.builtin.dnf:
        name: "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: yes
      tags: ["rpmfusion"]

    - name: Enable Google Chrome repository
      ansible.builtin.command: dnf config-manager setopt google-chrome.enabled=1
      tags: ["google_chrome"]

  rescue:
    - name: Repository Setup Failed
      ansible.builtin.debug:
        msg: >
          Failed to set up repositories.
          Error details: {{ ansible_failed_result | default('Unknown error') }}
          This might be due to network connectivity issues or repository availability.
      tags: ["repo_setup"]

    - name: Set repository setup status
      ansible.builtin.set_fact:
        repository_setup_failed: true
      tags: ["repo_setup"]

  tags: ["repositories"]

# DNF Configuration Block
- name: DNF Configuration
  block:
    - name: Configure DNF for better performance
      ansible.builtin.lineinfile:
        path: /etc/dnf/dnf.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: "^fastestmirror=", line: "fastestmirror=1" }
        - {
            regexp: "^max_parallel_downloads=",
            line: "max_parallel_downloads=10",
          }
        - {
            regexp: "^clean_requirements_on_remove=",
            line: "clean_requirements_on_remove=True",
          }
      tags: ["dnf_config"]

    - name: Set repository priorities
      ansible.builtin.shell: |
        dnf config-manager setopt "fedora.priority=10"
        dnf config-manager setopt "fedora-updates.priority=10"
        dnf config-manager setopt "fedora-cisco-openh264.priority=20"
        dnf config-manager setopt "rpmfusion-*.priority=40"
      changed_when: false
      tags: ["repo_priorities"]

  rescue:
    - name: DNF Configuration Failed
      ansible.builtin.debug:
        msg: >
          Failed to configure DNF settings.
          Error details: {{ ansible_failed_result | default('Unknown error') }}
          DNF may still function with default settings.
      tags: ["dnf_config"]

    - name: Set DNF configuration status
      ansible.builtin.set_fact:
        dnf_config_failed: true
      tags: ["dnf_config"]

  tags: ["dnf_configuration"]

# Cache Update Block
- name: Package Cache Update
  block:
    - name: Update package cache
      ansible.builtin.dnf:
        update_cache: yes
      tags: ["cache_update"]

  rescue:
    - name: Cache Update Failed
      ansible.builtin.debug:
        msg: >
          Failed to update package cache.
          Error details: {{ ansible_failed_result | default('Unknown error') }}
          You may need to run 'dnf clean all && dnf makecache' manually.
      tags: ["cache_update"]

  tags: ["cache"]
