---
# SSH role - simplified

- name: Configure SSH daemon
  template:
    src: etc/sshd/sshd_config.j2
    dest: /etc/ssh/sshd_config
  notify: Restart sshd

- name: Enable SSH service
  service:
    name: sshd
    enabled: true
    state: started
  when: ssh.enable_sshd | default(true)

- name: Copy fuse configuration
  copy:
    src: etc/fuse.conf
    dest: /etc/fuse.conf

- name: Set SSH_ASKPASS environment variable
  lineinfile:
    dest: /etc/profile
    line: 'export SSH_ASKPASS="{% if ansible_distribution == ''Rocky'' %}/usr/libexec/gcr-ssh-askpass{% else %}/usr/lib/ssh/x11-ssh-askpass{% endif %}"'
    mode: "0644"

- name: Create user SSH directory
  file:
    path: "/home/{{ user.name }}/.ssh"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0700"
