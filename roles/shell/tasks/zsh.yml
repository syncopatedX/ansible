---

- block:
    - name: Install zshell packages
      aur:
        use: auto
        name: "{{ item }}"
        state: present
      with_items:
        - "{{ packages__zsh }}"
      become: false
  rescue:
    - name: install zshell packages failed
      debug:
        msg: "Failed to install zshell packages"

  tags: ["packages", "shell_pkgs"]

- name: Install fd and ripgrep ohmyzsh plugins
  copy:
    src: "usr/share/oh-my-zsh/plugins/{{ item }}"
    dest: "/usr/share/oh-my-zsh/plugins/"
    owner: root
    group: root
    backup: True
  with_items:
    - fd
    - ripgrep

- name: Install zsh custom functions configs
  synchronize:
    src: home/.local/share/zsh/
    dest: "{{ user.home }}/.local/share/zsh/"
    recursive: yes
    mode: push
    delete: yes
    checksum: yes
    perms: no
    rsync_opts:
      - "--update"
      - "--omit-dir-times"
      - "--progress"
      - "--itemize-changes"
      - "--chown={{ user.name }}:{{ user.group }}"
  ignore_errors: "{{ ansible_check_mode }}"
  tags: ["zsh_functions"]

- name: Set zsh profile configs
  template:
    src: "home/{{ item }}.j2"
    dest: "{{ profile_config_dir }}/{{ item }}"
    owner: "{{ user.name }}"
    group: "{{ user.group }}"
    mode: "0644"
    backup: True
  with_items:
    - .zshenv
    - .zshrc
    - .zlogin
  tags: ["env", "profile"]

- name: Set .zprofile if getty autologin is enabled
  template:
    src: "home/.zprofile.j2"
    dest: "{{ profile_config_dir }}/.zprofile"
    owner: "{{ user.name }}"
    group: "{{ user.group }}"
    mode: "0644"
    backup: True
  when: window_manager == 'i3' and autologin|bool
